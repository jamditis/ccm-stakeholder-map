<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stakeholder map — CCM</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">

  <!-- Fonts: Source Serif for editorial gravitas, DM Sans for modern UI -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Source+Serif+4:ital,opsz,wght@0,8..60,400;0,8..60,600;0,8..60,700;1,8..60,400&display=swap" rel="stylesheet">

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'display': ['"Source Serif 4"', 'Georgia', 'serif'],
            'sans': ['"DM Sans"', 'system-ui', 'sans-serif'],
          },
          colors: {
            // Warm, confident palette
            ink: '#1a1a1a',
            paper: '#faf9f7',
            cream: '#f5f3ef',
            stone: '#e8e4de',
            muted: '#8a8580',
            // Category colors - refined, less saturated
            ally: { DEFAULT: '#2d9d5d', light: '#e8f5ed', dark: '#1e7a45' },
            advocate: { DEFAULT: '#4a7fc7', light: '#e6f0fa', dark: '#2d5a9e' },
            decisionmaker: { DEFAULT: '#8b5fc7', light: '#f0e8f7', dark: '#6b3fa7' },
            obstacle: { DEFAULT: '#cf5858', light: '#fceaea', dark: '#a63c3c' },
            dependency: { DEFAULT: '#d4874c', light: '#faf0e6', dark: '#b06a32' },
            opportunity: { DEFAULT: '#c4a82e', light: '#faf8e6', dark: '#9a8420' },
          },
        }
      }
    }
  </script>

  <!-- html2pdf.js for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Custom styles -->
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-paper min-h-screen font-sans text-ink antialiased">

  <!-- Subtle texture overlay -->
  <div class="fixed inset-0 pointer-events-none opacity-[0.015] z-50" style="background-image: url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noise%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.65%22 numOctaves=%223%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noise)%22/%3E%3C/svg%3E');"></div>

  <!-- Header -->
  <header class="bg-white/80 backdrop-blur-sm border-b border-stone sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-3 sm:px-6 sm:py-4 lg:px-8">
      <!-- Mobile: Two rows, Desktop: Single row -->
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between sm:gap-6">
        <!-- Top row: Logo + Actions -->
        <div class="flex items-center justify-between sm:justify-start sm:gap-6">
          <!-- Logo/Brand -->
          <div class="flex items-center gap-2 sm:gap-3">
            <div class="w-8 h-8 sm:w-9 sm:h-9 bg-ink rounded-lg flex items-center justify-center flex-shrink-0">
              <svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
              </svg>
            </div>
            <h1 class="font-display text-lg sm:text-xl font-semibold tracking-tight">Stakeholder map</h1>
          </div>

          <!-- Mobile: Import/Export/Help buttons -->
          <div class="flex items-center gap-1 sm:hidden">
            <button id="import-btn-mobile" class="p-2 text-muted hover:text-ink hover:bg-cream rounded-lg transition-all" title="Import map">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
              </svg>
            </button>
            <button id="export-menu-btn-mobile" class="p-2 text-muted hover:text-ink hover:bg-cream rounded-lg transition-all" title="Export map">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
              </svg>
            </button>
            <button id="help-btn-mobile" class="p-2 text-muted hover:text-ink hover:bg-cream rounded-lg transition-all" title="Help & tips">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
              </svg>
            </button>
          </div>

          <!-- Map selector - hidden on mobile, shown inline on desktop -->
          <div id="map-selector" class="hidden sm:flex items-center gap-3">
            <div class="h-6 w-px bg-stone"></div>
            <select id="current-map-select" class="text-sm bg-transparent border-0 text-muted focus:ring-0 focus:text-ink pr-8 cursor-pointer hover:text-ink transition-colors">
              <option value="">Select a map...</option>
            </select>
            <button id="new-map-btn" class="text-sm px-3.5 py-2 bg-ink text-white rounded-lg hover:bg-ink/80 transition-all hover:shadow-md active:scale-[0.98]">
              + New map
            </button>
          </div>
        </div>

        <!-- Mobile: Map selector row -->
        <div id="map-selector-mobile" class="flex items-center gap-2 sm:hidden">
          <select id="current-map-select-mobile" class="flex-1 text-sm bg-cream border-0 rounded-lg text-ink focus:ring-2 focus:ring-ink/10 py-2.5 px-3">
            <option value="">Select a map...</option>
          </select>
          <button id="new-map-btn-mobile" class="p-2.5 bg-ink text-white rounded-lg hover:bg-ink/80 transition-all active:scale-[0.98]" title="New map">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
          </button>
        </div>

        <!-- Desktop: Import/Export/Help buttons -->
        <div class="hidden sm:flex items-center gap-2">
          <button id="import-btn" class="text-sm px-3.5 py-2 text-muted hover:text-ink hover:bg-cream rounded-lg transition-all">
            Import
          </button>
          <button id="export-menu-btn" class="text-sm px-3.5 py-2 text-muted hover:text-ink hover:bg-cream rounded-lg transition-all flex items-center gap-1.5">
            Export
            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <button id="help-btn" class="text-sm px-3.5 py-2 text-muted hover:text-ink hover:bg-cream rounded-lg transition-all flex items-center gap-1.5" title="Help & tips (?)">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
            </svg>
            Help
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="max-w-7xl mx-auto px-4 py-4 sm:px-6 sm:py-8 lg:px-8">

    <!-- Welcome state (no map selected) -->
    <div id="welcome-state" class="py-6 sm:py-12">
      <div class="max-w-2xl mx-auto text-center px-2">
        <!-- Hero illustration -->
        <div class="relative mb-6 sm:mb-8">
          <div class="w-24 h-24 sm:w-32 sm:h-32 mx-auto relative">
            <!-- Animated connection lines -->
            <svg class="absolute inset-0 w-full h-full animate-pulse-slow" viewBox="0 0 128 128">
              <line x1="32" y1="40" x2="96" y2="40" stroke="#e8e4de" stroke-width="2" stroke-dasharray="4 4"/>
              <line x1="32" y1="88" x2="96" y2="88" stroke="#e8e4de" stroke-width="2" stroke-dasharray="4 4"/>
              <line x1="64" y1="24" x2="64" y2="104" stroke="#e8e4de" stroke-width="2" stroke-dasharray="4 4"/>
            </svg>
            <!-- Nodes -->
            <div class="absolute w-6 h-6 sm:w-8 sm:h-8 bg-ally rounded-full top-[22%] left-[18%] shadow-lg shadow-ally/20"></div>
            <div class="absolute w-8 h-8 sm:w-10 sm:h-10 bg-advocate rounded-full top-[14%] right-[15%] shadow-lg shadow-advocate/20"></div>
            <div class="absolute w-5 h-5 sm:w-7 sm:h-7 bg-decisionmaker rounded-full bottom-[22%] left-[22%] shadow-lg shadow-decisionmaker/20"></div>
            <div class="absolute w-7 h-7 sm:w-9 sm:h-9 bg-opportunity rounded-full bottom-[18%] right-[18%] shadow-lg shadow-opportunity/20"></div>
            <div class="absolute w-5 h-5 sm:w-6 sm:h-6 bg-ink rounded-full top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 shadow-lg"></div>
          </div>
        </div>

        <h2 class="font-display text-2xl sm:text-3xl font-semibold text-ink mb-2 sm:mb-3">Map your relationships</h2>
        <p class="text-muted text-base sm:text-lg leading-relaxed mb-6 sm:mb-8 max-w-md mx-auto">
          Visualize allies, advocates, decision-makers, and obstacles to navigate organizational relationships with confidence.
        </p>

        <button id="welcome-new-map-btn" class="inline-flex items-center gap-2 px-5 py-2.5 sm:px-6 sm:py-3 bg-ink text-white rounded-xl hover:bg-ink/80 transition-all hover:shadow-lg hover:shadow-ink/10 active:scale-[0.98] font-medium text-sm sm:text-base">
          <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
          </svg>
          Create your first map
        </button>
      </div>

      <!-- Template selection -->
      <div class="mt-10 sm:mt-16 max-w-3xl mx-auto">
        <div class="text-center mb-4 sm:mb-6">
          <p class="text-xs sm:text-sm text-muted uppercase tracking-wider font-medium">Or start from a template</p>
        </div>
        <div id="template-cards" class="grid grid-cols-2 gap-3 sm:gap-4 md:grid-cols-4">
          <!-- Templates inserted by JS -->
        </div>
      </div>
    </div>

    <!-- Map workspace (shown when map is selected) -->
    <div id="map-workspace" class="hidden">
      <!-- Map info bar -->
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4 sm:mb-6">
        <div class="flex items-center gap-2 sm:gap-4 min-w-0">
          <input id="map-name-input" type="text" class="font-display text-xl sm:text-2xl font-semibold border-0 border-b-2 border-transparent hover:border-stone focus:border-ink focus:ring-0 bg-transparent placeholder:text-muted transition-colors min-w-0 flex-1 sm:flex-none" placeholder="Untitled map">
          <span id="map-sector-badge" class="text-xs px-2 sm:px-3 py-1 sm:py-1.5 bg-cream text-muted rounded-full font-medium whitespace-nowrap flex-shrink-0"></span>
        </div>
        <div class="flex items-center gap-2 sm:gap-3">
          <label class="flex items-center gap-1.5 sm:gap-2 text-sm text-muted cursor-pointer hover:text-ink transition-colors">
            <input type="checkbox" id="map-private-toggle" class="rounded border-stone text-ink focus:ring-ink/20 cursor-pointer w-4 h-4">
            <span>Private</span>
          </label>
          <div class="h-5 w-px bg-stone"></div>
          <button id="delete-map-btn" class="text-sm px-2.5 sm:px-3 py-1.5 text-obstacle hover:bg-obstacle-light rounded-lg transition-all">
            Delete
          </button>
        </div>
      </div>

      <!-- View toggle -->
      <div class="flex items-center gap-1 mb-4 sm:mb-6 bg-cream rounded-xl p-1 w-full sm:w-fit">
        <button id="view-canvas-btn" class="flex-1 sm:flex-none px-4 py-2.5 sm:py-2 text-sm font-medium rounded-lg bg-white text-ink shadow-sm transition-all">
          Map view
        </button>
        <button id="view-list-btn" class="flex-1 sm:flex-none px-4 py-2.5 sm:py-2 text-sm font-medium rounded-lg text-muted hover:text-ink transition-all">
          List view
        </button>
      </div>

      <!-- Canvas view -->
      <div id="canvas-view" class="relative">
        <!-- Mobile Toolbar (bottom) -->
        <div class="sm:hidden fixed bottom-4 left-4 right-4 z-20 flex items-center justify-between gap-2 bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg shadow-ink/10 p-2 border border-stone/50">
          <button id="add-stakeholder-btn-mobile" class="flex items-center gap-1.5 px-3 py-2.5 bg-ink text-white text-sm rounded-xl hover:bg-ink/80 transition-all active:scale-[0.98] font-medium">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            Add
          </button>
          <div class="flex items-center gap-1">
            <button id="zoom-out-btn-mobile" class="p-2.5 text-muted hover:text-ink hover:bg-cream rounded-xl transition-all" title="Zoom out" aria-label="Zoom out">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM13.5 10.5h-6" />
              </svg>
            </button>
            <button id="zoom-in-btn-mobile" class="p-2.5 text-muted hover:text-ink hover:bg-cream rounded-xl transition-all" title="Zoom in" aria-label="Zoom in">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" />
              </svg>
            </button>
            <button id="zoom-reset-btn-mobile" class="p-2.5 text-muted hover:text-ink hover:bg-cream rounded-xl transition-all" title="Fit all stakeholders in view" aria-label="Reset view to fit all">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25" />
              </svg>
            </button>
          </div>
          <button id="legend-toggle-btn" class="p-2.5 text-muted hover:text-ink hover:bg-cream rounded-xl transition-all" title="Show category legend" aria-label="Show legend">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
            </svg>
          </button>
        </div>

        <!-- Desktop Toolbar (top-left) -->
        <div class="hidden sm:flex absolute top-4 left-4 z-10 items-center gap-2 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg shadow-ink/5 p-2 border border-stone/50">
          <button id="add-stakeholder-btn" class="flex items-center gap-2 px-4 py-2 bg-ink text-white text-sm rounded-lg hover:bg-ink/80 transition-all active:scale-[0.98] font-medium">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            Add stakeholder
          </button>
          <div class="w-px h-6 bg-stone"></div>
          <button id="zoom-in-btn" class="p-2 text-muted hover:text-ink hover:bg-cream rounded-lg transition-all" title="Zoom in (scroll up)" aria-label="Zoom in">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" />
            </svg>
          </button>
          <button id="zoom-out-btn" class="p-2 text-muted hover:text-ink hover:bg-cream rounded-lg transition-all" title="Zoom out (scroll down)" aria-label="Zoom out">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM13.5 10.5h-6" />
            </svg>
          </button>
          <button id="zoom-reset-btn" class="p-2 text-muted hover:text-ink hover:bg-cream rounded-lg transition-all" title="Fit all stakeholders in view" aria-label="Reset view to fit all">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25" />
            </svg>
          </button>
        </div>

        <!-- Legend (desktop: always visible, mobile: toggleable) -->
        <div id="canvas-legend" class="hidden sm:block absolute top-4 right-4 z-10 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg shadow-ink/5 p-3 sm:p-4 border border-stone/50 max-w-xs">
          <div class="flex items-center justify-between mb-2 sm:mb-3">
            <div class="text-xs font-medium text-muted uppercase tracking-wider">Categories</div>
            <div class="flex items-center gap-1">
              <button id="legend-expand-btn" class="hidden sm:block p-1 text-muted hover:text-ink rounded transition-all" title="Show descriptions">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </button>
              <button id="legend-close-btn" class="sm:hidden p-1 text-muted hover:text-ink rounded transition-all">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
          <div id="legend-compact" class="grid grid-cols-2 sm:grid-cols-1 gap-2 sm:space-y-2.5 text-sm">
            <div class="flex items-center gap-2 legend-item cursor-pointer hover:bg-cream/50 rounded px-1 -mx-1 py-0.5" data-category="ally">
              <span class="w-3 h-3 rounded-full bg-ally shadow-sm flex-shrink-0"></span>
              <span class="text-ink/80">Ally</span>
            </div>
            <div class="flex items-center gap-2 legend-item cursor-pointer hover:bg-cream/50 rounded px-1 -mx-1 py-0.5" data-category="advocate">
              <span class="w-3 h-3 rounded-full bg-advocate shadow-sm flex-shrink-0"></span>
              <span class="text-ink/80">Advocate</span>
            </div>
            <div class="flex items-center gap-2 legend-item cursor-pointer hover:bg-cream/50 rounded px-1 -mx-1 py-0.5" data-category="decisionmaker">
              <span class="w-3 h-3 rounded-full bg-decisionmaker shadow-sm flex-shrink-0"></span>
              <span class="text-ink/80 whitespace-nowrap">Decision maker</span>
            </div>
            <div class="flex items-center gap-2 legend-item cursor-pointer hover:bg-cream/50 rounded px-1 -mx-1 py-0.5" data-category="obstacle">
              <span class="w-3 h-3 rounded-full bg-obstacle shadow-sm flex-shrink-0"></span>
              <span class="text-ink/80">Obstacle</span>
            </div>
            <div class="flex items-center gap-2 legend-item cursor-pointer hover:bg-cream/50 rounded px-1 -mx-1 py-0.5" data-category="dependency">
              <span class="w-3 h-3 rounded-full bg-dependency shadow-sm flex-shrink-0"></span>
              <span class="text-ink/80">Dependency</span>
            </div>
            <div class="flex items-center gap-2 legend-item cursor-pointer hover:bg-cream/50 rounded px-1 -mx-1 py-0.5" data-category="opportunity">
              <span class="w-3 h-3 rounded-full bg-opportunity shadow-sm flex-shrink-0"></span>
              <span class="text-ink/80">Opportunity</span>
            </div>
          </div>
          <!-- Expanded legend with descriptions -->
          <div id="legend-expanded" class="hidden space-y-2 text-sm">
            <div class="flex items-start gap-2 p-1.5 rounded-lg bg-ally-light/50">
              <span class="w-3 h-3 rounded-full bg-ally shadow-sm flex-shrink-0 mt-0.5"></span>
              <div><span class="text-ink font-medium">Ally</span><p class="text-xs text-muted">Supports your work</p></div>
            </div>
            <div class="flex items-start gap-2 p-1.5 rounded-lg bg-advocate-light/50">
              <span class="w-3 h-3 rounded-full bg-advocate shadow-sm flex-shrink-0 mt-0.5"></span>
              <div><span class="text-ink font-medium">Advocate</span><p class="text-xs text-muted">Champions you to others</p></div>
            </div>
            <div class="flex items-start gap-2 p-1.5 rounded-lg bg-decisionmaker-light/50">
              <span class="w-3 h-3 rounded-full bg-decisionmaker shadow-sm flex-shrink-0 mt-0.5"></span>
              <div><span class="text-ink font-medium">Decision maker</span><p class="text-xs text-muted">Has authority over key decisions</p></div>
            </div>
            <div class="flex items-start gap-2 p-1.5 rounded-lg bg-obstacle-light/50">
              <span class="w-3 h-3 rounded-full bg-obstacle shadow-sm flex-shrink-0 mt-0.5"></span>
              <div><span class="text-ink font-medium">Obstacle</span><p class="text-xs text-muted">May block your progress</p></div>
            </div>
            <div class="flex items-start gap-2 p-1.5 rounded-lg bg-dependency-light/50">
              <span class="w-3 h-3 rounded-full bg-dependency shadow-sm flex-shrink-0 mt-0.5"></span>
              <div><span class="text-ink font-medium">Dependency</span><p class="text-xs text-muted">You rely on them</p></div>
            </div>
            <div class="flex items-start gap-2 p-1.5 rounded-lg bg-opportunity-light/50">
              <span class="w-3 h-3 rounded-full bg-opportunity shadow-sm flex-shrink-0 mt-0.5"></span>
              <div><span class="text-ink font-medium">Opportunity</span><p class="text-xs text-muted">Worth developing</p></div>
            </div>
          </div>
          <p class="text-xs text-muted/60 mt-2 hidden sm:block">Click ? for descriptions</p>
        </div>

        <!-- SVG Canvas -->
        <div id="canvas-container" class="bg-white rounded-xl sm:rounded-2xl border border-stone overflow-hidden shadow-sm canvas-height">
          <svg id="map-canvas" class="w-full h-full" style="cursor: grab; background: radial-gradient(circle at center, #faf9f7 0%, #f5f3ef 100%);">
            <!-- Grid pattern -->
            <defs>
              <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#e8e4de" stroke-width="0.5" opacity="0.5"/>
              </pattern>
              <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="#8a8580" />
              </marker>
            </defs>
            <rect width="100%" height="100%" fill="url(#grid)" />
            <g id="canvas-transform">
              <g id="connections-layer"></g>
              <g id="nodes-layer"></g>
            </g>
          </svg>
        </div>

        <!-- Canvas hint -->
        <p class="hidden sm:block text-center text-xs text-muted mt-3">Double-click canvas to add • Drag to move • Scroll to zoom</p>
        <p class="sm:hidden text-center text-xs text-muted mt-3 mb-16">Tap and hold to move • Pinch to zoom</p>
      </div>

      <!-- List view -->
      <div id="list-view" class="hidden">
        <!-- Mobile: Stack filters and button -->
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4 sm:mb-6">
          <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
            <select id="filter-category" class="text-sm bg-cream border-0 rounded-lg text-ink focus:ring-2 focus:ring-ink/10 py-2.5 px-3 sm:pr-8">
              <option value="">All categories</option>
              <option value="ally">Allies</option>
              <option value="advocate">Advocates</option>
              <option value="decisionmaker">Decision makers</option>
              <option value="obstacle">Obstacles</option>
              <option value="dependency">Dependencies</option>
              <option value="opportunity">Opportunities</option>
            </select>
            <select id="filter-influence" class="text-sm bg-cream border-0 rounded-lg text-ink focus:ring-2 focus:ring-ink/10 py-2.5 px-3 sm:pr-8">
              <option value="">All influence</option>
              <option value="high">High influence</option>
              <option value="medium">Medium influence</option>
              <option value="low">Low influence</option>
            </select>
          </div>
          <button id="add-stakeholder-list-btn" class="flex items-center justify-center gap-2 px-4 py-2.5 bg-ink text-white text-sm rounded-lg hover:bg-ink/80 transition-all active:scale-[0.98] font-medium w-full sm:w-auto">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            Add stakeholder
          </button>
        </div>

        <div id="stakeholder-list" class="grid gap-3 sm:gap-4">
          <!-- Stakeholder cards inserted by JS -->
        </div>

        <div id="empty-list-state" class="hidden text-center py-12 sm:py-16">
          <div class="w-14 h-14 sm:w-16 sm:h-16 mx-auto mb-3 sm:mb-4 bg-cream rounded-2xl flex items-center justify-center">
            <svg class="w-7 h-7 sm:w-8 sm:h-8 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
            </svg>
          </div>
          <h3 class="font-display text-base sm:text-lg font-semibold text-ink mb-2">No stakeholders yet</h3>
          <p class="text-sm text-muted px-4 mb-4">Add your first stakeholder to start building your map.</p>
          <div class="max-w-sm mx-auto px-4">
            <div class="bg-cream/50 rounded-xl p-4 text-left">
              <p class="text-xs font-medium text-ink mb-2">Getting started tips:</p>
              <ul class="text-xs text-muted space-y-1">
                <li>Think about people who influence your project</li>
                <li>Include both supporters and potential blockers</li>
                <li>Add notes to remember key relationship details</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Stakeholder modal -->
  <div id="stakeholder-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-end sm:items-center justify-center min-h-screen px-0 sm:px-4 py-0 sm:py-8">
      <div class="fixed inset-0 bg-ink/40 backdrop-blur-sm transition-opacity" id="modal-backdrop"></div>

      <div class="relative bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl shadow-ink/20 w-full max-w-lg transform transition-all max-h-[90vh] sm:max-h-none flex flex-col">
        <form id="stakeholder-form" class="flex flex-col h-full">
          <div class="px-4 sm:px-6 pt-4 sm:pt-6 pb-2 flex items-center justify-between flex-shrink-0">
            <h3 id="modal-title" class="font-display text-lg sm:text-xl font-semibold text-ink">Add stakeholder</h3>
            <button type="button" id="modal-close-x-btn" class="sm:hidden p-2 -mr-2 text-muted hover:text-ink rounded-lg transition-all">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <div class="px-4 sm:px-6 py-4 space-y-4 sm:space-y-5 overflow-y-auto flex-1">
            <div>
              <label for="stakeholder-name" class="block text-sm font-medium text-ink mb-1.5">Name <span class="text-obstacle">*</span></label>
              <input type="text" id="stakeholder-name" name="name" required class="w-full rounded-lg border-stone bg-cream/50 focus:border-ink focus:ring-ink/20 transition-colors placeholder:text-muted py-2.5">
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label for="stakeholder-role" class="block text-sm font-medium text-ink mb-1.5">Role/Title</label>
                <input type="text" id="stakeholder-role" name="role" class="w-full rounded-lg border-stone bg-cream/50 focus:border-ink focus:ring-ink/20 transition-colors placeholder:text-muted py-2.5">
              </div>
              <div>
                <label for="stakeholder-org" class="block text-sm font-medium text-ink mb-1.5">Organization</label>
                <input type="text" id="stakeholder-org" name="organization" class="w-full rounded-lg border-stone bg-cream/50 focus:border-ink focus:ring-ink/20 transition-colors placeholder:text-muted py-2.5">
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label for="stakeholder-category" class="block text-sm font-medium text-ink mb-1.5">Category <span class="text-obstacle">*</span></label>
                <select id="stakeholder-category" name="category" required class="w-full rounded-lg border-stone bg-cream/50 focus:border-ink focus:ring-ink/20 transition-colors py-2.5">
                  <option value="">Select...</option>
                  <option value="ally">Ally - Supports your work</option>
                  <option value="advocate">Advocate - Champions you to others</option>
                  <option value="decisionmaker">Decision maker - Has authority</option>
                  <option value="obstacle">Obstacle - May block progress</option>
                  <option value="dependency">Dependency - You rely on them</option>
                  <option value="opportunity">Opportunity - Worth developing</option>
                </select>
                <p class="text-xs text-muted mt-1">How does this person relate to your work?</p>
              </div>
              <div>
                <label for="stakeholder-influence" class="block text-sm font-medium text-ink mb-1.5">Influence</label>
                <select id="stakeholder-influence" name="influence" class="w-full rounded-lg border-stone bg-cream/50 focus:border-ink focus:ring-ink/20 transition-colors py-2.5">
                  <option value="medium">Medium - Has input on decisions</option>
                  <option value="high">High - Can approve or block</option>
                  <option value="low">Low - Limited direct impact</option>
                </select>
                <p class="text-xs text-muted mt-1">How much can they affect your project?</p>
              </div>
            </div>

            <div>
              <label for="stakeholder-avatar" class="block text-sm font-medium text-ink mb-1.5">Photo URL <span class="text-muted font-normal">(optional)</span></label>
              <input type="url" id="stakeholder-avatar" name="avatar" placeholder="https://..." class="w-full rounded-lg border-stone bg-cream/50 focus:border-ink focus:ring-ink/20 transition-colors placeholder:text-muted py-2.5">
            </div>

            <div>
              <label for="stakeholder-notes" class="block text-sm font-medium text-ink mb-1.5">Notes</label>
              <textarea id="stakeholder-notes" name="notes" rows="2" class="w-full rounded-lg border-stone bg-cream/50 focus:border-ink focus:ring-ink/20 transition-colors placeholder:text-muted resize-none py-2.5" placeholder="Context, history, relationship details..."></textarea>
              <p class="text-xs text-muted mt-1">Background info, past interactions, current status of relationship</p>
            </div>

            <div>
              <label for="stakeholder-tips" class="block text-sm font-medium text-ink mb-1.5">Interaction tips</label>
              <textarea id="stakeholder-tips" name="interactionTips" rows="2" class="w-full rounded-lg border-stone bg-cream/50 focus:border-ink focus:ring-ink/20 transition-colors placeholder:text-muted resize-none py-2.5" placeholder="Best way to reach them, preferences..."></textarea>
              <p class="text-xs text-muted mt-1">Preferred contact method, best times, communication style</p>
            </div>

            <div class="flex items-start gap-2 pt-1">
              <input type="checkbox" id="stakeholder-private" name="private" class="rounded border-stone text-ink focus:ring-ink/20 w-4 h-4 mt-0.5">
              <div>
                <label for="stakeholder-private" class="text-sm text-muted">Hide notes in shared exports</label>
                <p class="text-xs text-muted/70">Notes will be excluded from PDF, HTML, and Markdown exports</p>
              </div>
            </div>
          </div>

          <div class="px-4 sm:px-6 py-4 bg-cream/50 rounded-b-2xl flex flex-col-reverse sm:flex-row items-stretch sm:items-center justify-between gap-3 flex-shrink-0">
            <button type="button" id="modal-delete-btn" class="hidden px-4 py-2.5 text-obstacle text-sm font-medium hover:bg-obstacle-light rounded-lg transition-all">
              Delete
            </button>
            <div class="flex flex-col-reverse sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3 sm:ml-auto">
              <button type="button" id="modal-cancel-btn" class="px-4 py-2.5 text-muted text-sm font-medium hover:text-ink hover:bg-cream rounded-lg transition-all">
                Cancel
              </button>
              <button type="submit" class="px-5 py-2.5 bg-ink text-white text-sm font-medium rounded-lg hover:bg-ink/80 transition-all active:scale-[0.98]">
                Save
              </button>
            </div>
          </div>

          <input type="hidden" id="stakeholder-id" name="id">
        </form>
      </div>
    </div>
  </div>

  <!-- New map modal -->
  <div id="new-map-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-end sm:items-center justify-center min-h-screen px-0 sm:px-4 py-0 sm:py-8">
      <div class="fixed inset-0 bg-ink/40 backdrop-blur-sm transition-opacity" id="new-map-backdrop"></div>

      <div class="relative bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl shadow-ink/20 w-full max-w-md transform transition-all">
        <form id="new-map-form">
          <div class="px-4 sm:px-6 pt-4 sm:pt-6 pb-2 flex items-center justify-between">
            <h3 class="font-display text-lg sm:text-xl font-semibold text-ink">Create new map</h3>
            <button type="button" id="new-map-close-x-btn" class="sm:hidden p-2 -mr-2 text-muted hover:text-ink rounded-lg transition-all">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <div class="px-4 sm:px-6 py-4 space-y-4 sm:space-y-5">
            <div>
              <label for="new-map-name" class="block text-sm font-medium text-ink mb-1.5">Map name <span class="text-obstacle">*</span></label>
              <input type="text" id="new-map-name" name="name" required class="w-full rounded-lg border-stone bg-cream/50 focus:border-ink focus:ring-ink/20 transition-colors placeholder:text-muted py-2.5" placeholder="e.g., Q1 2026 Partnerships">
            </div>

            <div>
              <label for="new-map-sector" class="block text-sm font-medium text-ink mb-1.5">Template</label>
              <select id="new-map-sector" name="sector" class="w-full rounded-lg border-stone bg-cream/50 focus:border-ink focus:ring-ink/20 transition-colors py-2.5">
                <option value="custom">Blank canvas</option>
                <option value="collaborative-reporting">Collaborative reporting</option>
                <option value="training">Training & workshops</option>
                <option value="research">Research</option>
                <option value="membership">Membership/community</option>
              </select>
            </div>

            <div class="flex items-start gap-2">
              <input type="checkbox" id="new-map-private" name="private" class="rounded border-stone text-ink focus:ring-ink/20 w-4 h-4 mt-0.5">
              <div>
                <label for="new-map-private" class="text-sm text-muted">Private map</label>
                <p class="text-xs text-muted/70">Adds "CONFIDENTIAL" watermark to exported documents</p>
              </div>
            </div>
          </div>

          <div class="px-4 sm:px-6 py-4 bg-cream/50 rounded-b-2xl flex flex-col-reverse sm:flex-row items-stretch sm:items-center justify-end gap-2 sm:gap-3">
            <button type="button" id="new-map-cancel-btn" class="px-4 py-2.5 text-muted text-sm font-medium hover:text-ink hover:bg-cream rounded-lg transition-all">
              Cancel
            </button>
            <button type="submit" class="px-5 py-2.5 bg-ink text-white text-sm font-medium rounded-lg hover:bg-ink/80 transition-all active:scale-[0.98]">
              Create map
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Export menu dropdown (desktop) / bottom sheet (mobile) -->
  <div id="export-menu" class="hidden fixed sm:absolute inset-0 sm:inset-auto z-50">
    <!-- Mobile backdrop -->
    <div class="sm:hidden fixed inset-0 bg-ink/40 backdrop-blur-sm" id="export-menu-backdrop"></div>
    <!-- Menu content -->
    <div class="fixed sm:absolute bottom-0 sm:bottom-auto left-0 right-0 sm:left-auto w-full sm:w-56 rounded-t-2xl sm:rounded-xl shadow-xl shadow-ink/10 bg-white border-t sm:border border-stone overflow-hidden">
      <div class="sm:hidden flex items-center justify-between px-4 py-3 border-b border-stone">
        <span class="font-medium text-ink">Export options</span>
        <button id="export-menu-close-btn" class="p-1 text-muted hover:text-ink rounded transition-all">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="py-2" role="menu">
        <button id="export-json-btn" class="w-full text-left px-4 py-3 sm:py-2.5 text-sm text-ink hover:bg-cream transition-colors flex items-start gap-3" role="menuitem">
          <svg class="w-5 h-5 sm:w-4 sm:h-4 text-muted flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />
          </svg>
          <div>
            <div>Export as JSON</div>
            <div class="text-xs text-muted font-normal">Backup data or transfer to another browser</div>
          </div>
        </button>
        <button id="export-pdf-btn" class="w-full text-left px-4 py-3 sm:py-2.5 text-sm text-ink hover:bg-cream transition-colors flex items-start gap-3" role="menuitem">
          <svg class="w-5 h-5 sm:w-4 sm:h-4 text-muted flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
          </svg>
          <div>
            <div>Export field guide (PDF)</div>
            <div class="text-xs text-muted font-normal">Printable guide organized by category</div>
          </div>
        </button>
        <button id="export-html-btn" class="w-full text-left px-4 py-3 sm:py-2.5 text-sm text-ink hover:bg-cream transition-colors flex items-start gap-3" role="menuitem">
          <svg class="w-5 h-5 sm:w-4 sm:h-4 text-muted flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
          </svg>
          <div>
            <div>Export standalone HTML</div>
            <div class="text-xs text-muted font-normal">Share via email or host on any web server</div>
          </div>
        </button>
        <button id="export-md-btn" class="w-full text-left px-4 py-3 sm:py-2.5 text-sm text-ink hover:bg-cream transition-colors flex items-start gap-3" role="menuitem">
          <svg class="w-5 h-5 sm:w-4 sm:h-4 text-muted flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
          </svg>
          <div>
            <div>Export as Markdown</div>
            <div class="text-xs text-muted font-normal">Import into docs, wikis, or note-taking apps</div>
          </div>
        </button>
        <div class="my-2 border-t border-stone"></div>
        <button id="export-all-btn" class="w-full text-left px-4 py-3 sm:py-2.5 text-sm text-ink hover:bg-cream transition-colors flex items-start gap-3" role="menuitem">
          <svg class="w-5 h-5 sm:w-4 sm:h-4 text-muted flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0l-3-3m3 3l3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
          </svg>
          <div>
            <div>Export all maps (JSON)</div>
            <div class="text-xs text-muted font-normal">Full backup of all your stakeholder maps</div>
          </div>
        </button>
      </div>
      <!-- Safe area padding for mobile -->
      <div class="sm:hidden h-6"></div>
    </div>
  </div>

  <!-- Connection modal -->
  <div id="connection-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-end sm:items-center justify-center min-h-screen px-0 sm:px-4 py-0 sm:py-8">
      <div class="fixed inset-0 bg-ink/40 backdrop-blur-sm transition-opacity" id="connection-backdrop"></div>

      <div class="relative bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl shadow-ink/20 w-full max-w-md transform transition-all">
        <form id="connection-form">
          <div class="px-4 sm:px-6 pt-4 sm:pt-6 pb-2 flex items-center justify-between">
            <h3 class="font-display text-lg sm:text-xl font-semibold text-ink">Add connection</h3>
            <button type="button" id="connection-close-x-btn" class="sm:hidden p-2 -mr-2 text-muted hover:text-ink rounded-lg transition-all">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <div class="px-4 sm:px-6 py-4 space-y-4 sm:space-y-5">
            <div>
              <label for="connection-from" class="block text-sm font-medium text-ink mb-1.5">From</label>
              <select id="connection-from" name="from" required class="w-full rounded-lg border-stone bg-cream/50 focus:border-ink focus:ring-ink/20 transition-colors py-2.5">
                <option value="">Select stakeholder...</option>
              </select>
            </div>

            <div>
              <label for="connection-to" class="block text-sm font-medium text-ink mb-1.5">To</label>
              <select id="connection-to" name="to" required class="w-full rounded-lg border-stone bg-cream/50 focus:border-ink focus:ring-ink/20 transition-colors py-2.5">
                <option value="">Select stakeholder...</option>
              </select>
            </div>

            <div>
              <label for="connection-type" class="block text-sm font-medium text-ink mb-1.5">Relationship</label>
              <select id="connection-type" name="type" class="w-full rounded-lg border-stone bg-cream/50 focus:border-ink focus:ring-ink/20 transition-colors py-2.5">
                <option value="works-with">Works with</option>
                <option value="reports-to">Reports to</option>
                <option value="influences">Influences</option>
                <option value="blocks">Blocks</option>
                <option value="supports">Supports</option>
                <option value="depends-on">Depends on</option>
              </select>
            </div>

            <div>
              <label for="connection-notes" class="block text-sm font-medium text-ink mb-1.5">Notes <span class="text-muted font-normal">(optional)</span></label>
              <input type="text" id="connection-notes" name="notes" class="w-full rounded-lg border-stone bg-cream/50 focus:border-ink focus:ring-ink/20 transition-colors placeholder:text-muted py-2.5" placeholder="e.g., Weekly check-ins">
            </div>
          </div>

          <div class="px-4 sm:px-6 py-4 bg-cream/50 rounded-b-2xl flex flex-col-reverse sm:flex-row items-stretch sm:items-center justify-end gap-2 sm:gap-3">
            <button type="button" id="connection-cancel-btn" class="px-4 py-2.5 text-muted text-sm font-medium hover:text-ink hover:bg-cream rounded-lg transition-all">
              Cancel
            </button>
            <button type="submit" class="px-5 py-2.5 bg-ink text-white text-sm font-medium rounded-lg hover:bg-ink/80 transition-all active:scale-[0.98]">
              Add connection
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Help modal -->
  <div id="help-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-end sm:items-center justify-center min-h-screen px-0 sm:px-4 py-0 sm:py-8">
      <div class="fixed inset-0 bg-ink/40 backdrop-blur-sm transition-opacity" id="help-backdrop"></div>

      <div class="relative bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl shadow-ink/20 w-full max-w-2xl transform transition-all max-h-[90vh] sm:max-h-[80vh] flex flex-col">
        <div class="px-4 sm:px-6 pt-4 sm:pt-6 pb-2 flex items-center justify-between flex-shrink-0 border-b border-stone">
          <h3 class="font-display text-lg sm:text-xl font-semibold text-ink">Help & Getting Started</h3>
          <button type="button" id="help-close-btn" class="p-2 -mr-2 text-muted hover:text-ink rounded-lg transition-all">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div class="px-4 sm:px-6 py-4 sm:py-6 overflow-y-auto flex-1 space-y-6">
          <!-- Quick Start -->
          <div>
            <h4 class="font-display font-semibold text-ink mb-3 flex items-center gap-2">
              <span class="w-6 h-6 bg-ink text-white rounded-full text-xs flex items-center justify-center">1</span>
              Quick Start
            </h4>
            <ol class="text-sm text-muted space-y-2 ml-8 list-decimal">
              <li><strong class="text-ink">Create a map</strong> - Click "New map" or choose a template from the welcome screen</li>
              <li><strong class="text-ink">Add stakeholders</strong> - Click "Add stakeholder" or double-click anywhere on the canvas</li>
              <li><strong class="text-ink">Create connections</strong> - Right-click a stakeholder and select "Add connection"</li>
              <li><strong class="text-ink">Export your work</strong> - Use the Export menu to download as PDF, HTML, or Markdown</li>
            </ol>
          </div>

          <!-- Understanding Categories -->
          <div>
            <h4 class="font-display font-semibold text-ink mb-3 flex items-center gap-2">
              <span class="w-6 h-6 bg-ink text-white rounded-full text-xs flex items-center justify-center">2</span>
              Understanding Categories
            </h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
              <div class="flex items-start gap-2 p-2 rounded-lg bg-ally-light">
                <span class="w-3 h-3 rounded-full bg-ally mt-0.5 flex-shrink-0"></span>
                <div><strong class="text-ally-dark">Ally</strong><p class="text-ally-dark/70">Supports your work and goals</p></div>
              </div>
              <div class="flex items-start gap-2 p-2 rounded-lg bg-advocate-light">
                <span class="w-3 h-3 rounded-full bg-advocate mt-0.5 flex-shrink-0"></span>
                <div><strong class="text-advocate-dark">Advocate</strong><p class="text-advocate-dark/70">Actively champions you to others</p></div>
              </div>
              <div class="flex items-start gap-2 p-2 rounded-lg bg-decisionmaker-light">
                <span class="w-3 h-3 rounded-full bg-decisionmaker mt-0.5 flex-shrink-0"></span>
                <div><strong class="text-decisionmaker-dark">Decision maker</strong><p class="text-decisionmaker-dark/70">Has authority over key decisions</p></div>
              </div>
              <div class="flex items-start gap-2 p-2 rounded-lg bg-obstacle-light">
                <span class="w-3 h-3 rounded-full bg-obstacle mt-0.5 flex-shrink-0"></span>
                <div><strong class="text-obstacle-dark">Obstacle</strong><p class="text-obstacle-dark/70">May block or slow your progress</p></div>
              </div>
              <div class="flex items-start gap-2 p-2 rounded-lg bg-dependency-light">
                <span class="w-3 h-3 rounded-full bg-dependency mt-0.5 flex-shrink-0"></span>
                <div><strong class="text-dependency-dark">Dependency</strong><p class="text-dependency-dark/70">You rely on them to get work done</p></div>
              </div>
              <div class="flex items-start gap-2 p-2 rounded-lg bg-opportunity-light">
                <span class="w-3 h-3 rounded-full bg-opportunity mt-0.5 flex-shrink-0"></span>
                <div><strong class="text-opportunity-dark">Opportunity</strong><p class="text-opportunity-dark/70">Worth investing in this relationship</p></div>
              </div>
            </div>
          </div>

          <!-- Influence Levels -->
          <div>
            <h4 class="font-display font-semibold text-ink mb-3 flex items-center gap-2">
              <span class="w-6 h-6 bg-ink text-white rounded-full text-xs flex items-center justify-center">3</span>
              Influence Levels
            </h4>
            <div class="text-sm space-y-2 ml-8">
              <div class="flex items-start gap-3">
                <span class="px-2 py-0.5 rounded-full bg-decisionmaker-light text-decisionmaker-dark text-xs font-medium">High</span>
                <p class="text-muted">Can approve, block, or significantly change your project's direction</p>
              </div>
              <div class="flex items-start gap-3">
                <span class="px-2 py-0.5 rounded-full bg-advocate-light text-advocate-dark text-xs font-medium">Medium</span>
                <p class="text-muted">Has input on decisions or can influence high-influence stakeholders</p>
              </div>
              <div class="flex items-start gap-3">
                <span class="px-2 py-0.5 rounded-full bg-cream text-muted text-xs font-medium">Low</span>
                <p class="text-muted">Limited direct impact but may have useful information or connections</p>
              </div>
            </div>
          </div>

          <!-- Canvas Controls -->
          <div>
            <h4 class="font-display font-semibold text-ink mb-3 flex items-center gap-2">
              <span class="w-6 h-6 bg-ink text-white rounded-full text-xs flex items-center justify-center">4</span>
              Canvas Controls
            </h4>
            <div class="text-sm space-y-1 ml-8">
              <p class="text-muted"><strong class="text-ink">Double-click canvas</strong> - Add a new stakeholder at that position</p>
              <p class="text-muted"><strong class="text-ink">Drag stakeholder</strong> - Move them around the map</p>
              <p class="text-muted"><strong class="text-ink">Right-click stakeholder</strong> - Edit, add connection, or delete</p>
              <p class="text-muted"><strong class="text-ink">Scroll wheel</strong> - Zoom in and out</p>
              <p class="text-muted"><strong class="text-ink">Drag empty space</strong> - Pan around the map</p>
            </div>
          </div>

          <!-- Export Formats -->
          <div>
            <h4 class="font-display font-semibold text-ink mb-3 flex items-center gap-2">
              <span class="w-6 h-6 bg-ink text-white rounded-full text-xs flex items-center justify-center">5</span>
              Export Formats
            </h4>
            <div class="text-sm space-y-2 ml-8">
              <p class="text-muted"><strong class="text-ink">PDF Field Guide</strong> - Printable document organized by category with interaction tips</p>
              <p class="text-muted"><strong class="text-ink">Standalone HTML</strong> - Share an interactive map via email or web hosting</p>
              <p class="text-muted"><strong class="text-ink">Markdown</strong> - Import into docs, wikis, or note-taking apps</p>
              <p class="text-muted"><strong class="text-ink">JSON</strong> - Backup your data or import into another browser</p>
            </div>
          </div>

          <!-- Keyboard Shortcuts -->
          <div>
            <h4 class="font-display font-semibold text-ink mb-3 flex items-center gap-2">
              <span class="w-6 h-6 bg-ink text-white rounded-full text-xs flex items-center justify-center">?</span>
              Keyboard Shortcuts
            </h4>
            <div class="grid grid-cols-2 gap-2 text-sm ml-8">
              <div class="flex items-center gap-2">
                <kbd class="px-2 py-0.5 bg-cream rounded text-xs font-mono">Esc</kbd>
                <span class="text-muted">Close modals/menus</span>
              </div>
              <div class="flex items-center gap-2">
                <kbd class="px-2 py-0.5 bg-cream rounded text-xs font-mono">?</kbd>
                <span class="text-muted">Open this help</span>
              </div>
            </div>
          </div>

          <!-- Tips -->
          <div class="bg-cream rounded-xl p-4">
            <h4 class="font-medium text-ink mb-2 flex items-center gap-2">
              <svg class="w-4 h-4 text-advocate" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
              </svg>
              Pro Tips
            </h4>
            <ul class="text-sm text-muted space-y-1">
              <li>Use "Interaction tips" to record how best to communicate with each person</li>
              <li>Mark notes as private to exclude them from shared exports</li>
              <li>Templates include example stakeholders to help you get started</li>
              <li>All data is stored locally in your browser - export regularly for backup</li>
            </ul>
          </div>
        </div>

        <div class="px-4 sm:px-6 py-4 bg-cream/50 rounded-b-2xl flex items-center justify-end flex-shrink-0">
          <button type="button" id="help-done-btn" class="px-5 py-2.5 bg-ink text-white text-sm font-medium rounded-lg hover:bg-ink/80 transition-all active:scale-[0.98]">
            Got it
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden import input -->
  <input type="file" id="import-file-input" accept=".json" class="hidden">

  <!-- Scripts -->
  <script src="js/storage.js"></script>
  <script src="js/templates.js"></script>
  <script src="js/canvas.js"></script>
  <script src="js/export.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
